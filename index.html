<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RLT Raumzuordnung – Suche & PDF</title>

  <!-- Tailwind (helles UI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- XLSX (SheetJS) – wie in deinem funktionierenden Beispiel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- jsPDF + AutoTable (cdnjs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>

<body class="bg-gray-100 text-gray-900 p-4 sm:p-6 md:p-8">
  <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">

    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">RLT Raumzuordnung – Suche & PDF</h1>
        <p class="text-sm text-gray-600 mt-1">
          Excel laden → filtern nach Anlage/Raum/Luftart/Bereich/Fassade → Trefferliste als PDF exportieren.
        </p>
      </div>
      <button id="btnPdf"
        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition disabled:bg-gray-400 disabled:cursor-not-allowed"
        disabled>
        PDF herunterladen
      </button>
    </div>

    <div id="status" class="mb-4 p-3 rounded-lg border bg-yellow-50 border-yellow-200 text-yellow-900">
      Bitte Excel-Datei auswählen…
    </div>

    <!-- Controls -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">1) Excel-Datei</label>
        <input id="file"
          type="file" accept=".xlsx,.xls"
          class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
        <p id="meta" class="text-xs text-gray-500 mt-2"></p>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">2) Anlage</label>
        <input id="f_anlage" type="text" placeholder="z. B. 1.3 oder 2.6"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          disabled>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">3) Freitext</label>
        <input id="f_text" type="text" placeholder='Raum / Beschreibung / Nutzung…'
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          disabled>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">4) Luftart</label>
        <select id="f_luftart"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          disabled>
          <option value="Alle">Alle</option>
          <option value="Zuluft allgemein">Zuluft allgemein</option>
          <option value="Zuluft gekühlt">Zuluft gekühlt</option>
          <option value="Abluft belastet">Abluft belastet</option>
          <option value="Abluft unbelastet">Abluft unbelastet</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Etage</label>
        <select id="f_etage"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          disabled>
          <option value="Alle">Alle</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Fassade</label>
        <select id="f_fassade"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          disabled>
          <option value="Alle">Alle</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Bereich</label>
        <select id="f_bereich"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          disabled>
          <option value="Alle">Alle</option>
          <option value="NW">NW</option>
          <option value="SO">SO</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Raumnutzungsart</label>
        <select id="f_nutzung"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          disabled>
          <option value="Alle">Alle</option>
        </select>
      </div>

      <div class="lg:col-span-4 flex flex-wrap gap-2 mt-2">
        <button id="btnReset"
          class="bg-white hover:bg-gray-50 border border-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-sm transition disabled:bg-gray-100 disabled:cursor-not-allowed"
          disabled>
          Filter zurücksetzen
        </button>

        <div class="ml-auto text-sm text-gray-600 flex gap-4 items-center">
          <span>Versorgungseinträge: <b id="cnt_entries">0</b></span>
          <span>Betroffene Räume: <b id="cnt_rooms">0</b></span>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="overflow-auto rounded-lg border border-gray-200 bg-white">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Etage</th>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Raum</th>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Beschreibung</th>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Fassade</th>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Bereich</th>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Luftart</th>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Anlage</th>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Nutzung</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y divide-gray-200">
          <tr><td colspan="8" class="px-4 py-6 text-center text-gray-500">Keine Daten geladen.</td></tr>
        </tbody>
      </table>
    </div>

  </div>

<script>
(() => {
  // ====== Fachlogik: Spalten/Versorgungsarten ======
  const SERVICE_DEFS = [
    { key: "Zuluft_allgemein", label: "Zuluft allgemein" },
    { key: "Zuluft_gekühlt",   label: "Zuluft gekühlt" },
    { key: "Abluft_belastet",  label: "Abluft belastet" },
    { key: "Abluft_unbelastet",label: "Abluft unbelastet" },
  ];
  const AREAS = ["NW", "SO"];

  // ====== State ======
  const state = {
    mappedRaw: [],
    flat: [],
    filtered: [],
    meta: { fileName:"", sheetName:"", roomCount:0, flatCount:0 },
    filters: { anlage:"", text:"", etage:"Alle", fassade:"Alle", bereich:"Alle", luftart:"Alle", nutzung:"Alle" }
  };

  // ====== DOM ======
  const $ = (id) => document.getElementById(id);
  const elStatus = $("status");
  const elMeta = $("meta");
  const elTbody = $("tbody");

  function setStatus(kind, text){
    // kind: "warn" | "ok" | "err"
    if (kind === "ok") {
      elStatus.className = "mb-4 p-3 rounded-lg border bg-green-50 border-green-200 text-green-900";
    } else if (kind === "err") {
      elStatus.className = "mb-4 p-3 rounded-lg border bg-red-50 border-red-200 text-red-900";
    } else {
      elStatus.className = "mb-4 p-3 rounded-lg border bg-yellow-50 border-yellow-200 text-yellow-900";
    }
    elStatus.textContent = text;
  }

  function enableControls(){
    ["f_anlage","f_text","f_etage","f_fassade","f_bereich","f_luftart","f_nutzung","btnReset","btnPdf"]
      .forEach(id => $(id).disabled = false);
  }

  function disableControls(){
    ["f_anlage","f_text","f_etage","f_fassade","f_bereich","f_luftart","f_nutzung","btnReset","btnPdf"]
      .forEach(id => $(id).disabled = true);
  }

  function normalizeHeader(h){
    return String(h ?? "").trim().replace(/\s+/g, " ");
  }

  function toStr(v){
    if (v === null || v === undefined) return "";
    if (typeof v === "number") return String(v);
    return String(v).trim();
  }

  function uniqSorted(arr){
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,"de",{numeric:true}));
  }

  // Header-Handling: Duplikate -> .1, .2 ...
  function buildStableHeaders(headerRow){
    const seen = new Map();
    return headerRow.map(hRaw => {
      const h = normalizeHeader(hRaw);
      const n = seen.get(h) || 0;
      seen.set(h, n + 1);
      return n === 0 ? h : `${h}.${n}`;
    });
  }

  function buildServiceColumns(headers){
    const cols = [];
    for (const area of AREAS){
      for (const def of SERVICE_DEFS){
        const base = `${area}_${def.key}`;
        if (headers.includes(base)) cols.push({ header: base, area, luftart: def.label });

        let i = 1;
        while (headers.includes(`${base}.${i}`)){
          cols.push({ header: `${base}.${i}`, area, luftart: def.label });
          i++;
        }
      }
    }
    return cols;
  }

  function populateSelect(id, values){
    const sel = $(id);
    const cur = sel.value;
    sel.innerHTML = "";
    sel.appendChild(new Option("Alle","Alle"));
    values.forEach(v => sel.appendChild(new Option(v,v)));
    sel.value = [...sel.options].some(o => o.value === cur) ? cur : "Alle";
  }

  function applyFilters(){
    let rows = state.flat.slice();
    const f = state.filters;

    if (f.anlage.trim()){
      const needle = f.anlage.trim();
      rows = rows.filter(r => toStr(r.Anlage).includes(needle));
    }
    if (f.text.trim()){
      const n = f.text.trim().toLowerCase();
      rows = rows.filter(r => {
        const hay = [r.Raumnummer, r.RaumAlt, r.Raumbeschreibung, r.Raumnutzungsart]
          .map(toStr).join(" ").toLowerCase();
        return hay.includes(n);
      });
    }

    if (f.etage !== "Alle") rows = rows.filter(r => r.Etage === f.etage);
    if (f.fassade !== "Alle") rows = rows.filter(r => r.Fassade === f.fassade);
    if (f.bereich !== "Alle") rows = rows.filter(r => r.Bereich === f.bereich);
    if (f.luftart !== "Alle") rows = rows.filter(r => r.Luftart === f.luftart);
    if (f.nutzung !== "Alle") rows = rows.filter(r => r.Raumnutzungsart === f.nutzung);

    state.filtered = rows;
    renderTable();
    updateCounters();

    $("btnPdf").disabled = state.filtered.length === 0;
  }

  function updateCounters(){
    $("cnt_entries").textContent = String(state.filtered.length);
    const rooms = new Set(state.filtered.map(r => r.Raumnummer));
    $("cnt_rooms").textContent = String(rooms.size);
  }

  function renderTable(){
    elTbody.innerHTML = "";
    if (!state.filtered.length){
      elTbody.innerHTML = `<tr><td colspan="8" class="px-4 py-6 text-center text-gray-500">Keine Treffer.</td></tr>`;
      return;
    }

    for (const r of state.filtered){
      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50";
      tr.innerHTML = `
        <td class="px-4 py-2 text-sm text-gray-700">${escapeHtml(r.Etage)}</td>
        <td class="px-4 py-2 text-sm text-gray-700 font-mono">${escapeHtml(r.Raumnummer)}</td>
        <td class="px-4 py-2 text-sm text-gray-700">${escapeHtml(r.Raumbeschreibung)}</td>
        <td class="px-4 py-2 text-sm text-gray-700 font-mono">${escapeHtml(r.Fassade)}</td>
        <td class="px-4 py-2 text-sm text-gray-700 font-mono">${escapeHtml(r.Bereich)}</td>
        <td class="px-4 py-2 text-sm text-gray-700">${escapeHtml(r.Luftart)}</td>
        <td class="px-4 py-2 text-sm text-gray-700 font-mono">${escapeHtml(r.Anlage)}</td>
        <td class="px-4 py-2 text-sm text-gray-700">${escapeHtml(r.Raumnutzungsart)}</td>
      `;
      elTbody.appendChild(tr);
    }
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function resetFilters(){
    state.filters = { anlage:"", text:"", etage:"Alle", fassade:"Alle", bereich:"Alle", luftart:"Alle", nutzung:"Alle" };
    $("f_anlage").value = "";
    $("f_text").value = "";
    $("f_etage").value = "Alle";
    $("f_fassade").value = "Alle";
    $("f_bereich").value = "Alle";
    $("f_luftart").value = "Alle";
    $("f_nutzung").value = "Alle";
    applyFilters();
  }

  function exportPdf(){
    const ok = (window.jspdf && window.jspdf.jsPDF);
    if (!ok){
      setStatus("err","PDF-Bibliothek nicht verfügbar (jsPDF wurde nicht geladen).");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

    const now = new Date();
    const dt = now.toLocaleString("de-DE");

    const f = state.filters;
    const filterLine = [
      f.anlage ? `Anlage=${f.anlage}` : null,
      f.text ? `Text="${f.text}"` : null,
      f.etage !== "Alle" ? `Etage=${f.etage}` : null,
      f.fassade !== "Alle" ? `Fassade=${f.fassade}` : null,
      f.bereich !== "Alle" ? `Bereich=${f.bereich}` : null,
      f.luftart !== "Alle" ? `Luftart=${f.luftart}` : null,
      f.nutzung !== "Alle" ? `Nutzung=${f.nutzung}` : null
    ].filter(Boolean).join(" | ") || "keine Filter (alle Daten)";

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text("RLT Raumzuordnung – Trefferliste", 40, 40);

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text(`Quelle: ${state.meta.fileName || "-"} | Blatt: ${state.meta.sheetName || "-"} | Export: ${dt}`, 40, 58);
    doc.text(`Filter: ${filterLine}`, 40, 74);

    const rooms = new Set(state.filtered.map(r => r.Raumnummer));
    doc.text(`Treffer: ${state.filtered.length} Versorgungseinträge | Betroffene Räume: ${rooms.size}`, 40, 90);

    const head = [[ "Etage","Raum","Beschreibung","Fassade","Bereich","Luftart","Anlage","Nutzung" ]];
    const body = state.filtered.map(r => [r.Etage, r.Raumnummer, r.Raumbeschreibung, r.Fassade, r.Bereich, r.Luftart, r.Anlage, r.Raumnutzungsart]);

    doc.autoTable({
      head, body, startY: 110,
      styles: { font: "helvetica", fontSize: 8, cellPadding: 4 },
      margin: { left: 40, right: 40 }
    });

    const safe = (state.meta.fileName || "raumzuordnung")
      .replace(/\.[^.]+$/, "")
      .replace(/[^a-z0-9_-]+/gi, "_");

    doc.save(`${safe}_Treffer_${now.toISOString().slice(0,10)}.pdf`);
  }

  // ====== Datei laden (wie in deinem funktionierenden Beispiel) ======
  $("file").addEventListener("change", (event) => {
    const file = event.target.files && event.target.files[0];
    if (!file) return;

    // Prüfen ob XLSX wirklich da ist
    if (!window.XLSX){
      setStatus("err", "XLSX wurde nicht geladen. (cdnjs ist bei dir normal ok – ggf. Browser/Netz blockiert doch?)");
      return;
    }

    setStatus("warn", `Lade Datei: ${file.name} …`);
    disableControls();

    const reader = new FileReader();
    reader.onload = (e) => {
      try{
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        const aoa = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: true });
        const nonEmpty = aoa.filter(row => row && row.some(cell => cell !== null && cell !== undefined && cell !== ""));

        if (nonEmpty.length < 2){
          setStatus("err","Die Datei ist leer oder hat kein gültiges Tabellenformat.");
          return;
        }

        // Header: entweder erste oder zweite Zeile (wie in deinem Beispiel – robust)
        const headerCandidate1 = nonEmpty[0];
        const headerCandidate2 = nonEmpty[1];
        const useFirstAsHeader = headerCandidate1.some(v => typeof v === "string" && String(v).trim().length > 0);

        const headerRow = useFirstAsHeader ? headerCandidate1 : headerCandidate2;
        const dataRows  = useFirstAsHeader ? nonEmpty.slice(1) : nonEmpty.slice(2);

        const headers = buildStableHeaders(headerRow);

        // rows: array of objects
        const rows = dataRows.map(row => {
          const obj = {};
          headers.forEach((h, idx) => obj[h] = row[idx] ?? "");
          return obj;
        });

        const getKey = (cands) => cands.find(c => headers.includes(c)) || null;

        const kEtage   = getKey(["Etage"]);
        const kFassade = getKey(["Fassade"]);
        const kRaum    = getKey(["Raumnummer"]);
        const kAlt     = getKey(["Raum (ALT)"]);
        const kBez     = getKey(["Raumbeschreibung"]);
        const kNutz    = getKey(["Raumnutzungsart"]);

        const serviceCols = buildServiceColumns(headers);

        // Basisdaten
        state.mappedRaw = rows.map(r => ({
          Etage: toStr(r[kEtage]),
          Fassade: toStr(r[kFassade]),
          Raumnummer: toStr(r[kRaum]),
          RaumAlt: toStr(r[kAlt]),
          Raumbeschreibung: toStr(r[kBez]),
          Raumnutzungsart: toStr(r[kNutz]),
          __raw: r
        }));

        // flach
        state.flat = [];
        for (const r of state.mappedRaw){
          for (const sc of serviceCols){
            const anlage = toStr(r.__raw[sc.header]);
            if (anlage){
              state.flat.push({
                Etage: r.Etage,
                Fassade: r.Fassade,
                Raumnummer: r.Raumnummer,
                RaumAlt: r.RaumAlt,
                Raumbeschreibung: r.Raumbeschreibung,
                Raumnutzungsart: r.Raumnutzungsart,
                Bereich: sc.area,
                Luftart: sc.luftart,
                Anlage: anlage
              });
            }
          }
        }

        state.meta = {
          fileName: file.name,
          sheetName,
          roomCount: state.mappedRaw.length,
          flatCount: state.flat.length
        };

        elMeta.textContent = `Quelle: ${state.meta.fileName} • Blatt: ${state.meta.sheetName} • Räume: ${state.meta.roomCount} • Versorgungseinträge: ${state.meta.flatCount}`;

        // Dropdowns
        populateSelect("f_etage",   uniqSorted(state.mappedRaw.map(r => r.Etage)));
        populateSelect("f_fassade", uniqSorted(state.mappedRaw.map(r => r.Fassade)));
        populateSelect("f_nutzung", uniqSorted(state.mappedRaw.map(r => r.Raumnutzungsart)));

        enableControls();

        if (!serviceCols.length){
          setStatus("warn","Datei geladen, aber keine NW_/SO_-Versorgungsspalten erkannt (Header prüfen).");
        } else if (!state.flat.length){
          setStatus("warn","Datei geladen, aber 0 Versorgungseinträge gefunden (Anlagen-Spalten leer?).");
        } else {
          setStatus("ok", `Datei geladen: ${file.name} – Räume: ${state.meta.roomCount} / Versorgungseinträge: ${state.meta.flatCount}`);
        }

        applyFilters();

      } catch(err){
        console.error(err);
        setStatus("err","Fehler beim Lesen der Datei: " + (err?.message ?? String(err)));
      }
    };

    reader.onerror = () => setStatus("err","Datei konnte nicht gelesen werden (FileReader Fehler).");
    reader.readAsArrayBuffer(file);
  });

  // ====== Filter Events ======
  function wireFilter(id, key){
    $(id).addEventListener("input", e => { state.filters[key] = e.target.value; applyFilters(); });
  }
  $("f_anlage").addEventListener("input", e => { state.filters.anlage = e.target.value; applyFilters(); });
  $("f_text").addEventListener("input", e => { state.filters.text = e.target.value; applyFilters(); });

  ["f_etage","f_fassade","f_bereich","f_luftart","f_nutzung"].forEach(id => {
    $(id).addEventListener("change", e => {
      const map = {
        f_etage:"etage", f_fassade:"fassade", f_bereich:"bereich", f_luftart:"luftart", f_nutzung:"nutzung"
      };
      state.filters[map[id]] = e.target.value;
      applyFilters();
    });
  });

  $("btnReset").addEventListener("click", resetFilters);
  $("btnPdf").addEventListener("click", exportPdf);

  // Start
  disableControls();
  setStatus("warn","Bitte Excel-Datei auswählen…");
})();
</script>
</body>
</html>
