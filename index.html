<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RLT Raumzuordnung – Suche & PDF</title>

  <!-- PDF: jsPDF + AutoTable -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- XLSX (SheetJS) - Primary -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <!-- XLSX Fallback (falls jsDelivr blockiert) -->
  <script>
    // Wenn jsDelivr blockiert ist, laden wir nachträglich von unpkg nach.
    window.addEventListener("load", () => {
      if (!window.XLSX) {
        const s = document.createElement("script");
        s.src = "https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js";
        s.defer = true;
        s.onload = () => console.log("XLSX via unpkg geladen.");
        s.onerror = () => console.error("XLSX konnte auch via unpkg nicht geladen werden.");
        document.head.appendChild(s);
      }
    });
  </script>

  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#526170; --txt:#0f172a; --line:#d8e0ea;
      --accent:#2563eb; --accent2:#1d4ed8; --warnBg:#fff7e6; --warnLine:#f2c15c;
      --okBg:#ecfdf5; --okLine:#34d399; --input:#f8fafc;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--txt); }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; }
    .topbar{ display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    h1{ margin:0; font-size:20px; }
    .sub{ margin:6px 0 0; color:var(--muted); font-size:13px; max-width:900px; line-height:1.35; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px; background:#fff; }
    .grid{ display:grid; grid-template-columns:360px 1fr; gap:14px; margin-top:14px; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; box-shadow: 0 1px 3px rgba(15,23,42,0.06); }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input, select, button{
      width:100%; background:var(--input); color:var(--txt); border:1px solid var(--line);
      border-radius:12px; padding:10px 10px; outline:none;
    }
    input::placeholder{ color:#7b8b9a; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btnRow{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button{ cursor:pointer; font-weight:700; }
    button.primary{ background: linear-gradient(180deg, var(--accent), var(--accent2)); border-color:#1e40af; color:#fff; }
    button.ghost{ background:#fff; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .hint{ margin-top:8px; color:var(--muted); font-size:12px; line-height:1.35; }
    .warn{ border-left:4px solid var(--warnLine); padding:10px 12px; background:var(--warnBg); border-radius:12px; }
    .ok{ border-left:4px solid var(--okLine); padding:10px 12px; background:var(--okBg); border-radius:12px; }
    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .small{ font-size:12px; color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:top; }
    th{ color:var(--muted); font-size:12px; font-weight:800; position:sticky; top:0; background:var(--card); }
    td{ font-size:13px; }
    hr{ border:none; border-top:1px solid var(--line); margin:14px 0; }
    .kpi { display:flex; gap:8px; flex-wrap:wrap; }
    .kpi .pill { background: #fff; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>RLT Raumzuordnung – Suche & PDF-Export</h1>
        <p class="sub">
          Excel laden → nach Anlage/Raum/Luftart/Bereich/Fassade filtern → Trefferliste als PDF exportieren.
          Verarbeitung erfolgt lokal im Browser.
        </p>
      </div>
      <div class="pill">
        <span>GitHub Pages</span><span class="mono">•</span><span>ohne Backend</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div id="status" class="warn">Start… Bibliotheken werden geprüft…</div>

        <div class="btnRow" style="margin-top:10px;">
          <button id="btn_selftest" class="ghost">Selbsttest (Bibliotheken prüfen)</button>
        </div>

        <label>Datei (Excel .xlsx)</label>
        <input id="file" type="file" accept=".xlsx,.xls" />

        <div class="hint">
          Tipp: Bei Störung einer Anlage (z. B. „2.6“) direkt im Feld „Anlage“ filtern.
        </div>

        <hr />

        <h3 style="margin:0 0 10px; font-size:14px;">Suchmasken</h3>

        <label>Anlage (z. B. 1.3 / 2.6)</label>
        <input id="f_anlage" placeholder="Anlagennummer eingeben…" />

        <label>Freitext (Raum / Alt-Raum / Beschreibung / Nutzung)</label>
        <input id="f_text" placeholder='z. B. "CP-E1-104" oder "Labor"…' />

        <div class="row">
          <div>
            <label>Etage</label>
            <select id="f_etage"><option>Alle</option></select>
          </div>
          <div>
            <label>Fassade</label>
            <select id="f_fassade"><option>Alle</option></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Bereich</label>
            <select id="f_bereich">
              <option>Alle</option>
              <option>NW</option>
              <option>SO</option>
            </select>
          </div>
          <div>
            <label>Luftart</label>
            <select id="f_luftart">
              <option>Alle</option>
              <option>Zuluft allgemein</option>
              <option>Zuluft gekühlt</option>
              <option>Abluft belastet</option>
              <option>Abluft unbelastet</option>
            </select>
          </div>
        </div>

        <label>Raumnutzungsart</label>
        <select id="f_nutzung"><option>Alle</option></select>

        <div class="btnRow">
          <button id="btn_reset" class="ghost" disabled>Filter zurücksetzen</button>
          <button id="btn_pdf" class="primary" disabled>Treffer als PDF herunterladen</button>
        </div>

        <div class="hint" id="meta"></div>
        <div class="hint" id="debug" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <div class="toolbar">
          <div>
            <div style="font-weight:900; font-size:14px;">Trefferliste</div>
            <div class="kpi">
              <span class="pill">Versorgungseinträge: <b id="cnt_entries">0</b></span>
              <span class="pill">Betroffene Räume: <b id="cnt_rooms">0</b></span>
            </div>
          </div>
        </div>

        <div style="overflow:auto; max-height:70vh; border-radius:12px;">
          <table>
            <thead>
              <tr>
                <th>Etage</th>
                <th>Raum</th>
                <th>Beschreibung</th>
                <th>Fassade</th>
                <th>Bereich</th>
                <th>Luftart</th>
                <th>Anlage</th>
                <th>Nutzung</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr>
                <td colspan="8" class="small" style="padding:14px;">
                  Keine Treffer. (Datei laden oder Filter anpassen.)
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="hint" style="margin-top:10px;">
          Logik: Jede gefüllte Versorgungsspalte wird als eigener Versorgungseintrag geführt (auch bei doppelten Spalten in Excel).
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Konfiguration (Excel-Spalten)
    // -----------------------------
    const SERVICE_DEFS = [
      { key: "Zuluft_allgemein", label: "Zuluft allgemein" },
      { key: "Zuluft_gekühlt",   label: "Zuluft gekühlt" },
      { key: "Abluft_belastet",  label: "Abluft belastet" },
      { key: "Abluft_unbelastet",label: "Abluft unbelastet" },
    ];
    const AREAS = ["NW", "SO"];

    // -----------------------------
    // State
    // -----------------------------
    const state = {
      rawRows: [],
      flatRows: [],
      filtered: [],
      meta: { sourceName:"", sheetName:"", rowCount:0, flatCount:0 },
      filters: { anlage:"", text:"", etage:"Alle", fassade:"Alle", nutzung:"Alle", bereich:"Alle", luftart:"Alle" }
    };

    // -----------------------------
    // Helpers
    // -----------------------------
    const $ = (id) => document.getElementById(id);

    function setStatus(type, msg){
      const el = $("status");
      el.className = type;
      el.textContent = msg;
    }

    function setDebug(msg){
      $("debug").innerHTML = msg || "";
    }

    function normalizeHeader(h){
      return String(h ?? "").trim().replace(/\s+/g, " ");
    }

    function toStr(v){
      if (v === null || v === undefined) return "";
      if (typeof v === "number") return String(v); // 2.6 bleibt 2.6
      return String(v).trim();
    }

    function uniqueSorted(arr){
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b) => a.localeCompare(b, "de"));
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function rebuildSelectOptions(selectEl, values){
      const cur = selectEl.value;
      selectEl.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.textContent = "Alle";
      optAll.value = "Alle";
      selectEl.appendChild(optAll);
      for (const v of values){
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        selectEl.appendChild(o);
      }
      if ([...selectEl.options].some(o => o.value === cur)) selectEl.value = cur;
      else selectEl.value = "Alle";
    }

    function buildServiceColumns(headers){
      // findet z.B. NW_Zuluft_allgemein, NW_Abluft_belastet, NW_Abluft_belastet.1 ...
      const map = [];
      for (const area of AREAS){
        for (const def of SERVICE_DEFS){
          const base = `${area}_${def.key}`;
          if (headers.includes(base)) map.push({ header: base, area, luftart: def.label });

          // Duplikate: .1, .2, ...
          let i = 1;
          while (headers.includes(`${base}.${i}`)){
            map.push({ header: `${base}.${i}`, area, luftart: def.label });
            i++;
          }
        }
      }
      return map;
    }

    function updateCounts(){
      $("cnt_entries").textContent = String(state.filtered.length);
      const rooms = new Set(state.filtered.map(r => r.Raumnummer));
      $("cnt_rooms").textContent = String(rooms.size);
    }

    function renderTable(){
      const tb = $("tbody");
      tb.innerHTML = "";
      if (state.filtered.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="8" class="small" style="padding:14px;">Keine Treffer. (Datei laden oder Filter anpassen.)</td>`;
        tb.appendChild(tr);
        return;
      }
      for (const r of state.filtered){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.Etage)}</td>
          <td class="mono">${escapeHtml(r.Raumnummer)}</td>
          <td>${escapeHtml(r.Raumbeschreibung)}</td>
          <td class="mono">${escapeHtml(r.Fassade)}</td>
          <td class="mono">${escapeHtml(r.Bereich)}</td>
          <td>${escapeHtml(r.Luftart)}</td>
          <td class="mono">${escapeHtml(r.Anlage)}</td>
          <td>${escapeHtml(r.Raumnutzungsart)}</td>
        `;
        tb.appendChild(tr);
      }
    }

    function applyFilters(){
      let rows = state.flatRows.slice();
      const f = state.filters;

      if (f.anlage.trim()){
        const needle = f.anlage.trim();
        rows = rows.filter(r => toStr(r.Anlage).includes(needle));
      }
      if (f.text.trim()){
        const n = f.text.trim().toLowerCase();
        rows = rows.filter(r => {
          const hay = [r.Raumnummer, r.RaumAlt, r.Raumbeschreibung, r.Raumnutzungsart]
            .map(toStr).join(" ").toLowerCase();
          return hay.includes(n);
        });
      }
      if (f.etage !== "Alle") rows = rows.filter(r => r.Etage === f.etage);
      if (f.fassade !== "Alle") rows = rows.filter(r => r.Fassade === f.fassade);
      if (f.nutzung !== "Alle") rows = rows.filter(r => r.Raumnutzungsart === f.nutzung);
      if (f.bereich !== "Alle") rows = rows.filter(r => r.Bereich === f.bereich);
      if (f.luftart !== "Alle") rows = rows.filter(r => r.Luftart === f.luftart);

      state.filtered = rows;

      renderTable();
      updateCounts();

      $("btn_pdf").disabled = state.filtered.length === 0;
      $("btn_reset").disabled = state.flatRows.length === 0;
    }

    function selfTest(){
      const okXlsx = !!window.XLSX;
      const okPdf  = !!(window.jspdf && window.jspdf.jsPDF);

      const msg = [
        `XLSX: ${okXlsx ? "OK" : "FEHLT"}`,
        `jsPDF: ${okPdf ? "OK" : "FEHLT"}`
      ].join(" | ");

      if (okXlsx && okPdf) {
        setStatus("ok", `Bereit. ${msg}. Bitte Excel-Datei laden.`);
      } else {
        setStatus("warn", `Bibliotheken fehlen. ${msg}. Wahrscheinlich blockiert ein Netzwerk/Adblocker das CDN.`);
      }
    }

    async function handleFile(file){
      try{
        // Warten, falls XLSX über Fallback erst nachgeladen wurde
        if (!window.XLSX){
          setStatus("warn", "XLSX ist noch nicht verfügbar. Bitte 2–3 Sekunden warten und erneut laden oder Selbsttest klicken.");
          return;
        }

        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type:"array" });
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];

        // Stabil bei doppelten Spalten: als Array lesen
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: true });
        if (!aoa.length || aoa.length < 2){
          setStatus("warn", "Die Tabelle ist leer oder konnte nicht gelesen werden.");
          return;
        }

        // Header trimmen + Duplikate als .1, .2, ...
        const rawHeaderRow = aoa[0].map(h => normalizeHeader(h));
        const seen = new Map();
        const headers = rawHeaderRow.map(h => {
          const key = h || "";
          const n = (seen.get(key) || 0);
          seen.set(key, n + 1);
          return n === 0 ? key : `${key}.${n}`;
        });

        // Zeilen -> Objekte
        const rows = [];
        for (let i = 1; i < aoa.length; i++){
          const arr = aoa[i];
          if (!arr || arr.every(v => toStr(v) === "")) continue;
          const obj = {};
          for (let c = 0; c < headers.length; c++){
            obj[headers[c]] = arr[c] ?? "";
          }
          rows.push(obj);
        }
        if (!rows.length){
          setStatus("warn", "Keine Datenzeilen gefunden.");
          return;
        }

        // Key Finder
        const getKey = (cands) => cands.find(c => headers.includes(c)) || null;

        const kEtage   = getKey(["Etage"]);
        const kFassade = getKey(["Fassade"]);     // wird aus "Fassade " korrekt
        const kSch11   = getKey(["Schacht1.1"]);
        const kSch12   = getKey(["Schacht1.2"]);
        const kRaum    = getKey(["Raumnummer"]);
        const kAlt     = getKey(["Raum (ALT)"]);
        const kBez     = getKey(["Raumbeschreibung"]);
        const kNutz    = getKey(["Raumnutzungsart"]);

        const missing = [];
        if (!kEtage) missing.push("Etage");
        if (!kFassade) missing.push("Fassade");
        if (!kRaum) missing.push("Raumnummer");
        if (!kBez) missing.push("Raumbeschreibung");

        const serviceCols = buildServiceColumns(headers);
        if (serviceCols.length === 0) missing.push("NW_/SO_-Versorgungsspalten");

        const mappedRaw = rows.map(row => ({
          Etage: toStr(row[kEtage]),
          Fassade: toStr(row[kFassade]),
          Schacht11: toStr(row[kSch11]),
          Schacht12: toStr(row[kSch12]),
          Raumnummer: toStr(row[kRaum]),
          RaumAlt: toStr(row[kAlt]),
          Raumbeschreibung: toStr(row[kBez]),
          Raumnutzungsart: toStr(row[kNutz]),
          __raw: row
        }));

        // flach
        const flat = [];
        for (const r of mappedRaw){
          for (const sc of serviceCols){
            const anlage = toStr(r.__raw[sc.header]);
            if (anlage){
              flat.push({
                Etage: r.Etage,
                Fassade: r.Fassade,
                Raumnummer: r.Raumnummer,
                RaumAlt: r.RaumAlt,
                Raumbeschreibung: r.Raumbeschreibung,
                Raumnutzungsart: r.Raumnutzungsart,
                Bereich: sc.area,
                Luftart: sc.luftart,
                Anlage: anlage,
                QuelleSpalte: sc.header
              });
            }
          }
        }

        state.rawRows = mappedRaw;
        state.flatRows = flat;
        state.meta = { sourceName:file.name, sheetName, rowCount:mappedRaw.length, flatCount:flat.length };

        rebuildSelectOptions($("f_etage"), uniqueSorted(mappedRaw.map(r => r.Etage)));
        rebuildSelectOptions($("f_fassade"), uniqueSorted(mappedRaw.map(r => r.Fassade)));
        rebuildSelectOptions($("f_nutzung"), uniqueSorted(mappedRaw.map(r => r.Raumnutzungsart)));

        $("meta").textContent =
          `Quelle: ${state.meta.sourceName} • Blatt: ${state.meta.sheetName} • Räume: ${state.meta.rowCount} • Versorgungseinträge: ${state.meta.flatCount}`;

        setDebug(
          `<span class="mono">Debug:</span> Service-Spalten erkannt: <b>${serviceCols.length}</b> • ` +
          `Flat-Einträge erzeugt: <b>${flat.length}</b>` +
          (serviceCols.length ? ` (z. B. <span class="mono">${escapeHtml(serviceCols[0].header)}</span>)` : "")
        );

        if (missing.length){
          setStatus("warn", "Datei geladen, aber es fehlen/abweichen Spalten: " + missing.join(", "));
        } else if (flat.length === 0) {
          setStatus("warn", "Datei geladen, aber es wurden 0 Versorgungseinträge gefunden. (Sind die Anlagen-Spalten leer?)");
        } else {
          setStatus("ok", `Datei geladen: ${file.name} – ${mappedRaw.length} Räume / ${flat.length} Versorgungseinträge.`);
        }

        applyFilters();

      } catch (e){
        console.error(e);
        setStatus("warn", "Fehler beim Lesen der Datei: " + (e?.message ?? String(e)));
      }
    }

    function exportPdf(){
      if (!(window.jspdf && window.jspdf.jsPDF)) {
        setStatus("warn", "jsPDF ist nicht verfügbar (CDN blockiert?).");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

      const now = new Date();
      const dt = now.toLocaleString("de-DE");

      const f = state.filters;
      const filterLine = [
        f.anlage ? `Anlage=${f.anlage}` : null,
        f.text ? `Text="${f.text}"` : null,
        f.etage !== "Alle" ? `Etage=${f.etage}` : null,
        f.fassade !== "Alle" ? `Fassade=${f.fassade}` : null,
        f.nutzung !== "Alle" ? `Nutzung=${f.nutzung}` : null,
        f.bereich !== "Alle" ? `Bereich=${f.bereich}` : null,
        f.luftart !== "Alle" ? `Luftart=${f.luftart}` : null,
      ].filter(Boolean).join(" | ") || "keine Filter (alle Daten)";

      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("RLT Raumzuordnung – Trefferliste", 40, 40);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Quelle: ${state.meta.sourceName || "-"} | Blatt: ${state.meta.sheetName || "-"} | Export: ${dt}`, 40, 58);
      doc.text(`Filter: ${filterLine}`, 40, 74);

      const rooms = new Set(state.filtered.map(r => r.Raumnummer));
      doc.text(`Treffer: ${state.filtered.length} Versorgungseinträge | Betroffene Räume: ${rooms.size}`, 40, 90);

      const head = [[ "Etage","Raum","Beschreibung","Fassade","Bereich","Luftart","Anlage","Nutzung" ]];
      const body = state.filtered.map(r => ([
        r.Etage, r.Raumnummer, r.Raumbeschreibung, r.Fassade, r.Bereich, r.Luftart, r.Anlage, r.Raumnutzungsart
      ]));

      doc.autoTable({
        head,
        body,
        startY: 110,
        styles: { font: "helvetica", fontSize: 8, cellPadding: 4 },
        margin: { left: 40, right: 40 }
      });

      const safeName = (state.meta.sourceName || "raumzuordnung")
        .replace(/\.[^.]+$/, "")
        .replace(/[^a-z0-9_-]+/gi, "_");

      doc.save(`${safeName}_Treffer_${now.toISOString().slice(0,10)}.pdf`);
    }

    // -----------------------------
    // Events / Init
    // -----------------------------
    window.addEventListener("load", () => {
      // Status erst nach load: dann sind defer-scripte geladen (oder nicht)
      selfTest();
    });

    $("btn_selftest").addEventListener("click", selfTest);

    $("file").addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if (f) handleFile(f);
    });

    $("f_anlage").addEventListener("input", (e) => { state.filters.anlage = e.target.value; applyFilters(); });
    $("f_text").addEventListener("input", (e) => { state.filters.text = e.target.value; applyFilters(); });
    $("f_etage").addEventListener("change", (e) => { state.filters.etage = e.target.value; applyFilters(); });
    $("f_fassade").addEventListener("change", (e) => { state.filters.fassade = e.target.value; applyFilters(); });
    $("f_bereich").addEventListener("change", (e) => { state.filters.bereich = e.target.value; applyFilters(); });
    $("f_luftart").addEventListener("change", (e) => { state.filters.luftart = e.target.value; applyFilters(); });
    $("f_nutzung").addEventListener("change", (e) => { state.filters.nutzung = e.target.value; applyFilters(); });

    $("btn_reset").addEventListener("click", () => {
      state.filters = { anlage:"", text:"", etage:"Alle", fassade:"Alle", nutzung:"Alle", bereich:"Alle", luftart:"Alle" };
      $("f_anlage").value = "";
      $("f_text").value = "";
      $("f_etage").value = "Alle";
      $("f_fassade").value = "Alle";
      $("f_bereich").value = "Alle";
      $("f_luftart").value = "Alle";
      $("f_nutzung").value = "Alle";
      applyFilters();
    });

    $("btn_pdf").addEventListener("click", exportPdf);
  </script>
</body>
</html>
